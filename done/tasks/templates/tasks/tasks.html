{% comment %} {% extends 'base.html' %} {% endcomment %}

{% block content %}

<style>
  .excel-table {
    width: 100%;
    border-collapse: collapse;
    color: #fff;
    background-color: #333;
  }

  .excel-table th, .excel-table td {
    border: 1px solid #666;
    padding: 10px;
    text-align: left;
  }

  .excel-table th {
    background-color: #555;
  }

  .excel-table tr:nth-child(even) {
    background-color: #444;
  }
</style>

<h2>Your Tasks</h2>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>



<div id="excel-table"></div>
<button id="add-task-button">+</button>
<dialog id="add-task-dialog">
  <form id="add-task-form">
    <label for="name">Name:</label><br>
    <input type="text" id="name" name="name"><br>
    <label for="priority">Priority:</label><br>
    <input type="text" id="priority" name="priority"><br>
    <!-- Add other fields as needed -->
    <input type="submit" value="Create Task">
    <button id="close-dialog" type="button">Close</button>
  </form>
</dialog>

<script>
  $(document).ready(function() {
    // get the priorities list to populate the dropdown menu
    var priorities = {{ priorities|safe }};
    var statuses = {{ statuses|safe }};
    var contextNames = {{ context_names|safe }};
    var assigneeNames = {{ assignee_names|safe }};
    

    // create a date editor because the default one is not working
    var dateEditor = function(cell, onRendered, success, cancel){
      var cellValue = cell.getValue(),
          input = document.createElement("input");
  
      input.type = "text";
      input.value = cellValue;
  
      onRendered(function(){
          input.focus();
          input.style.height = "100%";
  
          flatpickr(input, {
              defaultDate: cellValue || null,
              onChange: function(selectedDates, dateStr, instance){
                  success(dateStr);
              },
          });
      });
  
      return input;
    };

    var table = new Tabulator("#excel-table", {
      ajaxURL: "/task-get/",
      ajaxProgressiveLoad: "scroll",
      paginationSize: 20,
      columns: [
        { title: "Name", field: "name", editor: "input" },
        { title: "Priority", field: "priority", editor: "select", editorParams: {values: priorities} },
        { title: "Compound Priority", field: "compound_priority", editor: "number" },
        { title: "Deadline", field: "deadline", editor: dateEditor },
        { title: "Status", field: "status", editor: "select", editorParams: {values: statuses} },
        { title: "Effort", field: "effort", editor: "number" },
        { title: "Context", field: 'context__name', editor: "select", editorParams: {values: contextNames} },
        { title: "Assignee", field: "assignee__name", editor: "select", editorParams: {values: assigneeNames} },
        {title: "Parent", field: "parent__project_name", editor: false},
      ],
      cellEdited: function(cell) {
        // send the new data to the server
        console.log(cell.getField() + " of row " + cell.getRow().getIndex() + " changed to " + cell.getValue());
        $.ajax({
          url: "/task-update/",  // replace with the actual path
          method: "POST",
          data: {
            id: cell.getRow().getIndex(),
            field: cell.getField(),
            value: cell.getValue()
          }
        });
      }
    });

    // Open the form to create a new task
    document.getElementById('add-task-button').addEventListener('click', function() {
      document.getElementById('add-task-dialog').showModal();
    });

    document.getElementById('close-dialog').addEventListener('click', function() {
      document.getElementById('add-task-dialog').close();
    });

    $('#add-task-form').on('submit', function(event) {
      event.preventDefault();

      $.ajax({
        url: '/create_task/',  // Replace with the URL of your view
        type: 'POST',
        data: $(this).serialize(),
        success: function(response) {
          document.getElementById('add-task-dialog').close();
          // Handle the response from the server
        }
      });
    });



  });
</script>
{% endblock %}